<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, follow" />
    <meta name="google-site-verification" content="lwyGMjMCHXSuJXWOc3iy1MG_Hd6yRBARF5H8NuMxUPg" />

    <title>Document</title>
    <link rel="canonical" href="http://localhost:9020<%= url %>">
    <link rel="preload" href="/css/ntd/manacanfilpoint_ntd.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/css/ntd/manacanfilpoint_ntd.css">
    </noscript>

    <link rel="preload" href="/css/common.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/css/common.css">
    </noscript>

    <link rel="preload" href="/css/leftnav_ntd.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/css/leftnav_ntd.css">
    </noscript>
    <link rel="preload" href="/css/header_ntd.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/css/header_ntd.css">
    </noscript>

    <link rel="preload" href="/css/footer.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/css/footer.css">
    </noscript>
    <script src="/js/jquery.min.js"></script>
</head>

<body>
    <div class="cnt">
        <div class="cnt-left" id="leftNav">
           <%- include('../layouts/leftnav_ntd', {}); %>
        </div>
        <div class="cnt-right" id="rightContent">
            <%- include('../layouts/header_ntd', {}); %>
            <div class="cnt-det">
                <div class="cnt-top d-flex justify-b">
                    <div class="cnt-info bg-white d-flex align-c">
                        <div class="cnt-avar rounded-circle">
                            <img class="rounded-circle" src="/images/img/cskh_image.jpg" width="114" height="114" alt="Logo CSKH">
                        </div>
                        <div class="cnt-gen fw-600">
                            <div class="cnt-gen-name mb-20px">
                                Chuyên viên hỗ trợ: <span class="color-main">Mrs. Nguyễn Hồng</span>
                            </div>
                            <div class="cnt-gen-phone mb-20px">
                                SĐT - Zalo: <span class="color-main">0972319116</span>
                            </div>
                            <div class="cnt-gen-mail">
                                Email: <span class="color-alert">nguyenhongg2609@gmail.com</span>
                            </div>
                        </div>
                    </div>
                    <div class="cnt-ban d-flex align-c">
                        <div class="cnt-ban-tit fw-700 color-white text-c">
                            Tuyển dụng nhanh, tuyển dụng hiệu quả, đăng tin miễn phí
                        </div>
                        <div class="cnt-ban-logo">
                            <img src="/images/logo/biglogo.svg" width="250" height="107" alt="Logo Image">
                        </div>
                    </div>
                </div>
                <div class="cnt-mag">
                    <div class="cnt-mag-title fs-4 fw-700 color-main mb-3">
                        ỨNG VIÊN TỪ ĐIỂM LỌC
                    </div>
                    <div class="cnt-mag-fil d-flex mb-3">
                        <select class="cnt-mag-fil-status bg-white">
                            <option value="0">Tất cả</option>
                            <option value="1">Điểm mất phí</option>
                            <option value="2">Điểm miễn phí</option>
                        </select>
                        <select class="cnt-mag-fil-job bg-white">
                            <option value="0">Trạng thái</option>
                            <option value="1">Đã có việc</option>
                            <option value="2">Không nghe máy</option>
                            <option value="3">Sai thông tin</option>
                            <option value="4">Khác</option>
                        </select>
                        <button class="cnt-mag-excel fw-700 color-white d-flex align-c fs-8">
                            <img src="/images/icon/down_ico.svg" width="21" height="19" alt="Export Icon">Xuất excel
                        </button>
                    </div>
                    <div class="cnt-mag-table">
                        <table id="filTable">
                            <thead>
                                <tr>
                                    <th>
                                        STT
                                    </th>
                                    <th>
                                        Ứng viên
                                    </th>
                                    <th>
                                        Trạng thái
                                    </th>
                                    <th>
                                        Ngày xem hồ sơ
                                    </th>
                                    <th>
                                        Vị trí
                                    </th>
                                    <th>
                                        Điểm lọc
                                    </th>
                                    <th>
                                        Ghi chú
                                    </th>
                                    <th>
                                        Giải pháp tuyển dụng
                                    </th>
                                    <th width="5%">
    
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="filTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="cnt-mag-paginate d-flex justify-c flex-wr">
                    </div>

                </div>
            </div>
            <div id="noteModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Nhập ghi chú</h2>
                    <textarea id="noteTextarea" rows="4" cols="50"></textarea>
                    <button id="cancelNoteBtn">Hủy</button>
                    <button id="saveNoteBtn">Lưu</button>
                </div>
            </div>
            <%- include('../layouts/footer', {}); %>
            <script>
                $(document).ready(function() {
                    $(window).scroll(function() {
                        var $leftNav = $('.lnav');
                        var $rightContent = $('#rightContent');
                        var rightContentHeight = $rightContent.outerHeight(true);
                        var rightContentOffsetTop = $rightContent.offset().top;
                        var rightContentBottom = rightContentOffsetTop + rightContentHeight;
                        var scrollTop = $(window).scrollTop();
                        var windowHeight = $(window).height();
                        var leftNavHeight = $leftNav.outerHeight(true);
            
                        if (scrollTop + leftNavHeight > rightContentBottom) {
                            $leftNav.css({
                                position: 'absolute',
                                top: (rightContentHeight - leftNavHeight) + 'px',
                                overflow: 'auto'
                            });
                        } else {
                            $leftNav.css({
                                position: 'fixed',
                                top: '0'
                            });
                        }
                    });
                });
            </script>
            <script>
                $(document).ready(function() {
                    $('.nhead-rig-togm').click(function() {
                        $('#mobileMenu').slideDown(300);
                    });
                    $('.menu-mb-close').click(function() {
                        $('#mobileMenu').slideUp(300);
                    });
                });
                $(document).ready(function() {
                    $(".tog-mb").click(function() {
                        $(this).next(".menu-mb-clist").slideToggle();
                    });
                });
            </script>
            
            <script>
                // $(document).ready(function() {
                //     $('.lnav-tog').click(function() {
                //         var lnavList = $(this).next('.lnav-list');
                //         lnavList.slideToggle();
                //     });
                // });
            </script>
            
            <script>
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                }
            
                function formatDate(dateString) {
                    var date = new Date(dateString*1000);
                    var day = String(date.getDate()).padStart(2, '0');
                    var month = String(date.getMonth() + 1).padStart(2, '0'); 
                    var year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            
                function formatTime(dateString) {
                    var date = new Date(dateString*1000);
                    var hours = String(date.getHours()).padStart(2, '0');
                    var minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${hours}:${minutes}`;
                }
            
                function deleteCandidate(use_id) {
                    var confirmed = confirm("Bạn có chắc chắn muốn xóa ứng viên này này?");
                    if (confirmed) {
                        $.ajax({
                            url: "http://localhost:3051/api/topcv1s/ntd/DeleteCandiFilterPoint",
                            type: "POST",
                            headers: {
                                "Authorization": "Bearer " + getCookie('accessToken')
                            },
                            data: {use_id: use_id},
                            success: function(response) {
                                if(response.data.result==true){
                                    alert("Xóa ứng viên thành công");
                                    renderTable(1);
                                }                
                            },
                            error: function(xhr, status, error) {
                                let errorMessage;
                                let response = JSON.parse(xhr.responseText);
                                if (response.error) {
                                    errorMessage = response.error.message;
                                }
                                alert(errorMessage);
                                console.log('Error:', errorMessage);
                            }
                        });
                    }
                }
            
                $(document).ready(function() {
                    var totalNews;
                    var totalPage;
                    var pageSize = 10;
                    $(".cnt-mag-fil-status, .cnt-mag-fil-job").change(function() {
                        renderTable(1); 
                    });
                
                    function renderTable(page) {
                        let fifilter1 = $(".cnt-mag-fil-status").val();
                        let fifilter2 = $(".cnt-mag-fil-job").val();
                        $.ajax({
                            url: "http://localhost:3051/api/topcv1s/ntd/CandiFilterPoint",
                            type: "POST",
                            headers: {
                                "Authorization": "Bearer " + getCookie('accessToken')
                            },
                            data: { page: page, pageSize: pageSize, fifilter1: fifilter1, filter2: fifilter2},
                            success: function(response) {
                                if(response.data.result==true){
                                    let candiFilterPoint = response.data.data;
                                    let start = (page - 1) * pageSize;
                                    let tableBody = $('#filTableBody');
                                    tableBody.empty();
            
                                    candiFilterPoint.forEach((candidate, index) => {
                                        let dateView = formatDate(candidate.used_day);
                                        let timeView = formatTime(candidate.used_day);
                                        let row = `<tr>
                                                    <td>${start + index + 1}</td>
                                                    <td>
                                                        <div class="d-flex align-c flex-dr-c gap-2 color-main">
                                                            <span class="fw-600">${candidate.use_name}</span>
                                                            <a class="fw-500" href="/ung-vien-uv-${candidate.use_id}">(Xem chi tiết)</a>
                                                        </div>
                                                    </td>
                                                    <td class="fw-600">
                                                        Đã mở
                                                    </td>
                                                    <td class="fw-600">
                                                        ${timeView} - ${dateView}
                                                    </td>
                                                    <td>
                                                        <a href="" class="fw-600 color-main">${candidate.use_job_name}</a>
                                                    </td>
                                                    <td class="color-main">
                                                        ${candidate.point}
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-c justify-c color-main gap-1 candiNote" data-value="${candidate.note_uv}" data-id="${candidate.use_id}">
                                                            <img alt="Note Icon" width="19" height="19" src="/images/icon/note_icon.svg"> Xem ghi chú
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <select class="can_status" data-id="${candidate.use_id}">
                                                            <option value="0" ${candidate.type_err == 0 ? 'selected' : ''}>Trạng thái</option>
                                                            <option value="1" ${candidate.type_err == 1 ? 'selected' : ''}>Đã có việc</option>
                                                            <option value="2" ${candidate.type_err == 2 ? 'selected' : ''}>Không nghe máy</option>
                                                            <option value="3" ${candidate.type_err == 3 ? 'selected' : ''}>Sai thông tin</option>
                                                            <option value="4" ${candidate.type_err == 4 ? 'selected' : ''}>Khác</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <img class="remove_can" src="/images/icon/remove_icon.svg" width="18" height="23" alt="Remove Icon" onclick="deleteCandidate(${candidate.use_id})">
                                                    </td>
                                                </tr>`;
                                        tableBody.append(row);
                                    });
                                }
                            },
                            error: function(xhr, status, error) {
                                let errorMessage;
                                let response = JSON.parse(xhr.responseText);
                                if (response.error) {
                                    errorMessage = response.error.message;
                                }
                                alert(errorMessage);
                                console.log('Error:', errorMessage);
                            }
                        });
                    }
                    // Phân trang tin đã đăng
                    function Paginate(totalPage, currentPage) {
                        $('.cnt-mag-paginate').empty();
                        $('.cnt-mag-paginate').append('<div class="pagi_pre_all"><<</div>');
                        $('.cnt-mag-paginate').append('<div class="pagi_pre"><</div>');
                        var startPage, endPage;
                        if (totalPage <= 4) {
                            startPage = 1;
                            endPage = totalPage;
                        } else if (currentPage <= 2) {
                            startPage = 1;
                            endPage = Math.min(totalPage, 4);
                        } else if (currentPage >= totalPage - 1) {
                            startPage = Math.max(1, totalPage - 3);
                            endPage = totalPage;
                        } else {
                            startPage = currentPage - 2;
                            endPage = currentPage + 2;
                        }
            
                        if (startPage > 1) {
                            $('.cnt-mag-paginate').append('<div class="pagi_page">1</div>');
                            if (startPage > 2) {
                                $('.cnt-mag-paginate').append('<div class="pagi_page">...</div>');
                            }
                        }
            
                        for (let i = startPage; i <= endPage; i++) {
                            if (i === currentPage) {
                                $('.cnt-mag-paginate').append('<div class="pagi_page active">' + i + '</div>');
                            } else {
                                $('.cnt-mag-paginate').append('<div class="pagi_page">' + i + '</div>');
                            }
                        }
            
                        if (endPage < totalPage) {
                            if (endPage < totalPage - 1) {
                                $('.cnt-mag-paginate').append('<div class="pagi_page">...</div>');
                            }
                            $('.cnt-mag-paginate').append('<div class="pagi_page">' + totalPage + '</div>');
                        }
            
                        $('.cnt-mag-paginate').append('<div class="pagi_next">></div>');
                        $('.cnt-mag-paginate').append('<div class="pagi_next_all">>></div>');
            
                        $('.pagi_page').click(function() {
                            if (!$(this).hasClass('active') && !$(this).text().includes('...')) {
                                let selectedPage = parseInt($(this).text());
                                $('.pagi_page').removeClass('active');
                                $(this).addClass('active');
                                renderTable(selectedPage);
                                Paginate(totalPage, selectedPage);
                            }
                        });
            
                        $('.pagi_pre').click(function() {
                            if (currentPage > 1) {
                                let prevPage = currentPage - 1;
                                renderTable(prevPage);
                                Paginate(totalPage, prevPage);
                            }
                        });
            
                        $('.pagi_next').click(function() {
                            if (currentPage < totalPage) {
                                let nextPage = currentPage + 1;
                                renderTable(nextPage);
                                Paginate(totalPage, nextPage);
                            }
                        });
            
                        $('.pagi_pre_all').click(function() {
                            renderTable(1);
                            Paginate(totalPage, 1);
                        });
            
                        $('.pagi_next_all').click(function() {
                            renderTable(totalPage);
                            Paginate(totalPage, totalPage);
                        });
                    }
                    // Khởi tạo trang đầu tiên và tổng số trang
                    $.ajax({
                        url: "http://localhost:3051/api/topcv1s/ntd/CandiFilterPoint",
                        type: "POST",
                        headers: {
                            "Authorization": "Bearer " + getCookie('accessToken')
                        },
                        data: { page: 1, pageSize: pageSize, fifilter1: 0, filter2: 0},
                        success: function(response) {
                                if(response.data.result==true){
                                    totalNews = response.data.total;
                                    totalPage = Math.ceil(totalNews / pageSize);
                                    Paginate(totalPage, 1);
                                    renderTable(1);
                                }                
                        },
                        error: function(xhr, status, error) {
                            let errorMessage;
                            let response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMessage = response.error.message;
                            }
                            alert(errorMessage);
                            console.log('Error:', errorMessage);
                        }
                    });
                    //Xuất dữ liệu ra file excel
                    $('.cnt-mag-excel').click(function() {
                        exportToExcel();
                    });
                    function exportToExcel() {
                        if(totalNews == 0){
                                alert('Không có ứng viên từ điểm lọc nào.');
                                return
                            }
                        var table = document.getElementById('filTable');
                        var rows = table.getElementsByTagName('tr');
                        var csvContent = "";
            
                        var headers = document.querySelectorAll('thead tr th');
                        var headerData = [];
                        headers.forEach(function(header) {
                            headerData.push('"' + header.innerText.trim() + '"');
                        });
                        csvContent += headerData.join(",") + "\n";
            
                        for (var i = 0; i < rows.length; i++) {
                            var row = rows[i];
                            var cells = row.cells;
                            var rowData = [];
                            for (var j = 0; j < cells.length; j++) {
                                rowData.push('"' + cells[j].innerText.trim() + '"'); 
                            }
                            csvContent += rowData.join(",") + "\n";
                        }
                        var bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                        var blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'candidate_list.csv';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                    //Chỉnh sửa giải pháp tuyển dụng
                    $(document).on('change', '.can_status', function() {
                        let status = $(this).val();
                        let use_id = $(this).data('id');
                        $.ajax({
                            url: "http://localhost:3051/api/topcv1s/ntd/UpdateStatusCandiFilterPoint",
                            type: "POST",
                            headers: {
                                "Authorization": "Bearer " + getCookie('accessToken')
                            },
                            data: {status: status, use_id: use_id},
                            success: function(response) {
                                if(response.data.result==true){
                                    alert("Đã cập nhật giải pháp tuyển dụng");
                                    renderTable(1);
                                }                
                            },
                            error: function(xhr, status, error) {
                                let errorMessage;
                                let response = JSON.parse(xhr.responseText);
                                if (response.error) {
                                    errorMessage = response.error.message;
                                }
                                alert(errorMessage);
                                console.log('Error:', errorMessage);
                            }
                        });
                    });
                    //Cập nhật ghi chú ứng viên
                    $(document).on('click', '.candiNote', function() {
                        let note = $(this).data('value');
                        let use_id = $(this).data('id');
                        $('#noteTextarea').val(note).data('id', use_id);
                        $('#noteModal').css('display', 'block'); 
                    });
                    // Đóng modal 
                    $(document).on('click', '.close', function() {
                        $('#noteModal').css('display', 'none'); 
                    });
                    $(document).on('click', '#cancelNoteBtn', function() {
                        $('#noteModal').css('display', 'none'); 
                    });
                    // Lưu ghi chú khi click vào nút Lưu
                    $(document).on('click', '#saveNoteBtn', function() {
                        let note = $('#noteTextarea').val();
                        let use_id = $('#noteTextarea').data('id');
                        $.ajax({
                            url: "http://localhost:3051/api/topcv1s/ntd/UpdateNoteCandiFilterPoint",
                            type: "POST",
                            headers: {
                                "Authorization": "Bearer " + getCookie('accessToken')
                            },
                            data: { note: note, use_id: use_id },
                            success: function(response) {
                                if (response.data.result == true) {
                                    alert("Đã cập nhật ghi chú");
                                    $('#noteModal').css('display', 'none');
                                    renderTable(1); 
                                }
                            },
                            error: function(xhr, status, error) {
                                let errorMessage;
                                let response = JSON.parse(xhr.responseText);
                                if (response.error) {
                                    errorMessage = response.error.message;
                                }
                                alert(errorMessage);
                                console.log('Error:', errorMessage);
                            }
                        });
                    });
                });
                
            </script>
            
            
</body>

</html>